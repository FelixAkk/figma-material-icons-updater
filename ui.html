<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Material Icons Updater</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .container {
      max-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      display: block;
      font-weight: 500;
      color: #333;
    }
    
    select, input[type="range"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input[type="range"] {
      padding: 0;
    }
    
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .style-fill-group {
      flex-direction: row;
      gap: 16px;
      align-items: center;
    }
    
    .style-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }
    
    input[type="checkbox"] {
      margin: 0;
    }
    
    
    button {
      align-self: stretch;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .primary-button {
      background: #007aff;
      color: white;
    }
    
    .primary-button:hover {
      background: #0056cc;
    }
    
    .primary-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .secondary-button {
      background: #f0f0f0;
      color: #333;
    }
    
    .secondary-button:hover {
      background: #e0e0e0;
    }
    
    .detected-name {
      padding: 8px;
      background: #f8f8f8;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      color: #333;
    }
    
    .status-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .preview, .status-message {
      padding: 12px;
      background: #f8f8f8;
      border-radius: 4px;
      text-align: center;
      min-height: 104px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .preview-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .preview-icon svg {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 2px;
      padding: 2px;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007aff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-text {
      color: #d32f2f;
      font-size: 12px;
      font-weight: 500;
    }
    
    .preview-label, .status-text {
      font-size: 12px;
      color: #666;
    }
    
    .preview-label code, .status-text code {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      background: rgba(0, 0, 0, 0.1);
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 11px;
    }
    
    .status-message.info {
      background: #e3f2fd;
    }
    
    .status-message.success {
      background: #e8f5e8;
    }
    
    .status-message.error {
      background: #ffebee;
    }
    
    .status-text.info {
      color: #1976d2;
    }
    
    .status-text.success {
      color: #2e7d32;
    }
    
    .status-text.error {
      color: #d32f2f;
    }
    
    .status {
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status.error {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
    }
    
    .settings-toggle {
      padding: 6px 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
      user-select: none;
      gap: 8px;
    }
    
    .settings-toggle:hover {
      background: #f0f0f0;
    }
    
    .settings-summary {
      font-size: 12px;
      color: #666;
    }
    
    .chevron {
      font-size: 10px;
      color: #666;
    }
    
    .settings-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-top: 16px
    }
    
    .hidden.hidden {
      display: none;
    }
    
    .progress-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-self: stretch;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #007aff;
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
  </style>
</head>
<body>
  <div class="container">
    
    <div class="status-area">
      <div class="preview" id="preview-container">
        <div class="preview-icon" id="preview-icon">
          <!-- Preview icon will be loaded here -->
        </div>
        <div class="preview-label" id="preview-label">Select a component to preview</div>
      </div>
      <div class="status-message hidden" id="status-message">
        <div class="progress-container hidden" id="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
        <div class="status-text" id="status-text"></div>
      </div>
      
    </div>
    
    <div class="form-group">
      <button type="button" class="primary-button" id="update-button" disabled>Update icon</button>
      
      <div class="settings-toggle" id="settings-toggle">
        <span class="settings-summary" id="settings-summary">Default settings</span>
        <span class="chevron" id="chevron">▼</span>
      </div>
      
      <div class="settings-panel hidden" id="settings-panel">
        <div class="form-group style-fill-group">
          <div class="style-container">
            <label for="style">Style</label>
            <select id="style">
              <option value="materialsymbolsoutlined">Outlined</option>
              <option value="materialsymbolsrounded">Rounded</option>
              <option value="materialsymbolssharp">Sharp</option>
            </select>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="fill">
            <label for="fill">Filled</label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="weight">Weight: <span id="weight-value">400</span></label>
          <input type="range" id="weight" min="100" max="700" step="100" value="400">
          <div class="range-labels">
            <span>100</span>
            <span>700</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="size">Size: <span id="size-value">24</span>px</label>
          <input type="range" id="size" min="0" max="3" step="1" value="1">
          <div class="range-labels">
            <span>20px</span>
            <span>24px</span>
            <span>40px</span>
            <span>48px</span>
          </div>
        </div>
        
        <div class="form-group">
          <label for="grade">Grade: <span id="grade-value">0</span></label>
          <input type="range" id="grade" min="0" max="2" step="1" value="1">
          <div class="range-labels">
            <span>-25</span>
            <span>0</span>
            <span>200</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // UI JavaScript for Material Icons Updater

    // UI elements
    const styleSelect = document.getElementById('style');
    const weightSlider = document.getElementById('weight');
    const weightValue = document.getElementById('weight-value');
    const sizeSlider = document.getElementById('size');
    const sizeValue = document.getElementById('size-value');
    const gradeSlider = document.getElementById('grade');
    const gradeValue = document.getElementById('grade-value');
    const fillCheckbox = document.getElementById('fill');
    const previewContainer = document.getElementById('preview-container');
    const previewIcon = document.getElementById('preview-icon');
    const previewLabel = document.getElementById('preview-label');
    const statusMessage = document.getElementById('status-message');
    const statusText = document.getElementById('status-text');
    const updateButton = document.getElementById('update-button');
    const settingsToggle = document.getElementById('settings-toggle');
    const settingsSummary = document.getElementById('settings-summary');
    const settingsPanel = document.getElementById('settings-panel');
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');

    // State
    let selectedNodes = [];
    let currentIconName = null;
    let previewState = 'none'; // 'none', 'loading', 'success', 'error'
    let settingsExpanded = false;
    let updateProgress = { current: 0, total: 0 };
    let currentParameters = {
      style: 'materialsymbolsoutlined',
      weight: 400,
      size: 24,
      grade: 0,
      fill: false
    };

    // Initialize UI
    function init() {
      // Update parameter displays
      updateWeightDisplay();
      updateSizeDisplay();
      updateGradeDisplay();
      updateSettingsSummary();
      
      // Add event listeners
      styleSelect.addEventListener('change', onStyleChange);
      weightSlider.addEventListener('input', onWeightChange);
      sizeSlider.addEventListener('input', onSizeChange);
      gradeSlider.addEventListener('input', onGradeChange);
      fillCheckbox.addEventListener('change', onFillChange);
      updateButton.addEventListener('click', onUpdateClick);
      settingsToggle.addEventListener('click', onSettingsToggle);
      
      // Listen for messages from the plugin
      window.onmessage = onPluginMessage;
      
      // Request initial selection from plugin
      parent.postMessage({ pluginMessage: { type: 'get-selection' } }, '*');
      
      // Initial resize
      resizeWindow();
    }

    function resizeWindow() {
      // Calculate the height needed for current content
      const container = document.querySelector('.container');
      const height = container.scrollHeight + 32; // Add padding
      const width = 320; // Keep width fixed
      
      // Send resize message to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'resize',
          width: width,
          height: height
        }
      }, '*');
    }

    // Event handlers
    function onStyleChange() {
      currentParameters.style = styleSelect.value;
      updateSettingsSummary();
      if (currentIconName) {
        updatePreview();
      }
    }

    function onWeightChange() {
      currentParameters.weight = parseInt(weightSlider.value);
      updateWeightDisplay();
      updateSettingsSummary();
      if (currentIconName) {
        updatePreview();
      }
    }

    function onSizeChange() {
      // Map slider index to actual size values
      const sizeMap = [20, 24, 40, 48];
      const sizeIndex = parseInt(sizeSlider.value);
      currentParameters.size = sizeMap[sizeIndex];
      updateSizeDisplay();
      updateSettingsSummary();
      if (currentIconName) {
        updatePreview();
      }
    }

    function onGradeChange() {
      // Map slider index to actual grade values
      const gradeMap = [-25, 0, 200];
      const gradeIndex = parseInt(gradeSlider.value);
      currentParameters.grade = gradeMap[gradeIndex];
      updateGradeDisplay();
      updateSettingsSummary();
      if (currentIconName) {
        updatePreview();
      }
    }

    function onFillChange() {
      currentParameters.fill = fillCheckbox.checked;
      updateSettingsSummary();
      if (currentIconName) {
        updatePreview();
      }
    }

    function onUpdateClick() {
      if (selectedNodes.length === 0) {
        return;
      }
      
      const count = selectedNodes.length;
      const nodeTypes = getNodeTypesSummary();
      
      // Initialize progress tracking
      updateProgress.current = 0;
      updateProgress.total = count;
      
      showStatus(`Updating ${count} ${nodeTypes}...`, 'info', count > 5);
      updateButton.disabled = true;
      
      // Send update request to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'update-icons',
          parameters: currentParameters,
          nodes: selectedNodes
        }
      }, '*');
    }

    function onSettingsToggle() {
      settingsExpanded = !settingsExpanded;
      if (settingsExpanded) {
        settingsPanel.classList.remove('hidden');
        settingsSummary.textContent = 'Close settings';
        document.getElementById('chevron').textContent = '▲';
      } else {
        settingsPanel.classList.add('hidden');
        updateSettingsSummary();
        document.getElementById('chevron').textContent = '▼';
      }
      
      // Resize window after panel toggle
      setTimeout(resizeWindow, 100); // Small delay for CSS transitions
    }

    // Handle messages from the plugin
    function onPluginMessage(event) {
      const message = event.data.pluginMessage;
      
      if (!message) {
        return;
      }
      
      switch (message.type) {
        case 'selection-changed':
          selectedNodes = message.nodes || [];
          updateSelectionStatus(message.hasUnsupportedNodes);
          updateDetectedName(message.hasUnsupportedNodes);
          break;
          
        case 'settings-loaded':
          // Load saved parameters invisibly when plugin starts
          if (message.parameters) {
            currentParameters = { ...message.parameters };
            updateUIFromParameters();
          }
          break;
          
        case 'update-progress':
          if (message.current !== undefined && message.total !== undefined) {
            // Progress update with numbers
            updateProgress.current = message.current;
            updateProgress.total = message.total;
            showStatus(message.message, 'info', true);
          } else {
            // Regular status message
            showStatus(message.message);
          }
          break;
          
        case 'update-complete':
          const count = message.count;
          const nodeTypes = count > 1 ? getNodeTypesSummary() : (selectedNodes[0]?.type === 'COMPONENT' ? 'component' : 'frame');
          showStatus(`Successfully updated ${count} ${nodeTypes}!`, 'success', false);
          updateButton.disabled = false;
          // Return to preview after a delay
          setTimeout(() => {
            updateDetectedName(false);
          }, 5000);
          break;
          
        case 'update-error':
          showStatus(message.error, 'error', false);
          updateButton.disabled = false;
          // Return to preview after a delay
          setTimeout(() => {
            updateDetectedName(false);
          }, 3000);
          break;
      }
    }

    // UI update functions
    function updateWeightDisplay() {
      weightValue.textContent = currentParameters.weight;
    }

    function updateSizeDisplay() {
      sizeValue.textContent = currentParameters.size;
    }

    function updateGradeDisplay() {
      gradeValue.textContent = currentParameters.grade;
    }

    function updateUIFromParameters() {
      // Update UI elements to match current parameters without triggering events
      styleSelect.value = currentParameters.style;
      weightSlider.value = currentParameters.weight.toString();
      
      // Map size value to slider index
      const sizeMap = [20, 24, 40, 48];
      const sizeIndex = sizeMap.indexOf(currentParameters.size);
      sizeSlider.value = sizeIndex >= 0 ? sizeIndex.toString() : '1';
      
      // Map grade value to slider index  
      const gradeMap = [-25, 0, 200];
      const gradeIndex = gradeMap.indexOf(currentParameters.grade);
      gradeSlider.value = gradeIndex >= 0 ? gradeIndex.toString() : '1';
      
      fillCheckbox.checked = currentParameters.fill;
      
      // Update displays
      updateWeightDisplay();
      updateSizeDisplay();
      updateGradeDisplay();
      updateSettingsSummary();
    }

    function updateSettingsSummary() {
      if (settingsExpanded) return; // Don't update when expanded
      
      const defaults = {
        style: 'materialsymbolsoutlined',
        weight: 400,
        size: 24,
        grade: 0,
        fill: false
      };
      
      const changes = [];
      
      // Check each parameter for non-default values
      if (currentParameters.style !== defaults.style) {
        const styleName = currentParameters.style === 'materialsymbolsrounded' ? 'Rounded' :
                         currentParameters.style === 'materialsymbolssharp' ? 'Sharp' : 'Outlined';
        changes.push(styleName);
      }
      
      if (currentParameters.fill !== defaults.fill && currentParameters.fill) {
        changes.push('Filled');
      }
      
      if (currentParameters.weight !== defaults.weight) {
        changes.push(`Weight ${currentParameters.weight}`);
      }
      
      if (currentParameters.size !== defaults.size) {
        changes.push(`${currentParameters.size}px`);
      }
      
      if (currentParameters.grade !== defaults.grade) {
        changes.push(`Grade ${currentParameters.grade}`);
      }
      
      settingsSummary.textContent = changes.length > 0 ? changes.join(', ') : 'Default settings';
    }

    function updateDetectedName(hasUnsupportedNodes) {
      // Check for unsupported node types first
      if (hasUnsupportedNodes) {
        currentIconName = null;
        showStatus('Select a component or frame', 'error');
        return;
      }
      
      if (selectedNodes.length === 0) {
        currentIconName = null;
        showStatus('Select a Material Icon to update', 'info');
        return;
      }
      
      if (selectedNodes.length > 1) {
        currentIconName = null;
        const nodeTypes = getNodeTypesSummary();
        showStatus(`${selectedNodes.length} ${nodeTypes} selected`, 'info');
        return;
      }
      
      // Single node selected
      const node = selectedNodes[0];
      if (node.iconName) {
        currentIconName = node.iconName;
        updatePreview();
      } else {
        currentIconName = null;
        const nodeType = node.type === 'COMPONENT' ? 'component' : 'frame';
        showStatus(`"${node.name}" is not a valid icon name`, 'error');
      }
    }

    function updateSelectionStatus(hasUnsupportedNodes) {
      const count = selectedNodes.length;
      
      // Disable button if no selection, unsupported nodes, or error state
      updateButton.disabled = count === 0 || hasUnsupportedNodes || isErrorState();
      
      // Update button text based on selection count
      if (count === 0) {
        updateButton.textContent = 'Update icon';
      } else if (count === 1) {
        updateButton.textContent = 'Update icon';
      } else {
        updateButton.textContent = 'Update icons';
      }
    }

    function isErrorState() {
      // Check if any selected node has invalid icon name
      return selectedNodes.some(node => !node.iconName);
    }

    function getNodeTypesSummary() {
      if (selectedNodes.length === 0) return '';
      
      const components = selectedNodes.filter(n => n.type === 'COMPONENT').length;
      const frames = selectedNodes.filter(n => n.type === 'FRAME').length;
      
      if (components > 0 && frames > 0) {
        return `component${components > 1 ? 's' : ''} and frame${frames > 1 ? 's' : ''}`;
      } else if (components > 0) {
        return `component${components > 1 ? 's' : ''}`;
      } else if (frames > 0) {
        return `frame${frames > 1 ? 's' : ''}`;
      }
      return 'nodes';
    }

    function updatePreview() {
      if (!currentIconName) {
        return;
      }
      
      setPreviewState('loading', 'Loading preview...');
      
      const url = buildIconUrl(currentIconName, currentParameters);
      
      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.text();
        })
        .then(svgContent => {
          // Create a temporary div to parse the SVG
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = svgContent;
          const svg = tempDiv.querySelector('svg');
          
          if (svg) {
            // Scale the icon 2x for better visibility
            const scaledSize = currentParameters.size * 2;
            svg.style.width = scaledSize + 'px';
            svg.style.height = scaledSize + 'px';
          }
          
          setPreviewState('success', `Preview: <code>${currentIconName}</code>`, tempDiv.innerHTML);
        })
        .catch(error => {
          console.error('Preview load error:', error);
          setPreviewState('error', `Icon <code>${currentIconName}</code> not found`);
        });
    }

    function showPreview() {
      previewContainer.classList.remove('hidden');
      statusMessage.classList.add('hidden');
    }
    
    function showStatus(message, type = 'info', showProgress = false) {
      previewContainer.classList.add('hidden');
      statusMessage.classList.remove('hidden');
      statusMessage.className = `status-message ${type}`;
      
      // Show status text with counter if updating
      statusText.classList.remove('hidden');
      if (showProgress && updateProgress.total > 0) {
        statusText.textContent = `${message} (${updateProgress.current} / ${updateProgress.total})`;
      } else {
        statusText.textContent = message;
      }
      statusText.className = `status-text ${type}`;
      
      // Show progress bar when updating >5 icons
      if (showProgress && updateProgress.total > 5) {
        progressContainer.classList.remove('hidden');
        updateProgressBar();
      } else {
        progressContainer.classList.add('hidden');
      }
    }

    function updateProgressBar() {
      const percentage = updateProgress.total > 0 ? (updateProgress.current / updateProgress.total) * 100 : 0;
      progressFill.style.width = percentage + '%';
    }
    
    function setPreviewState(state, label, svgContent = null) {
      previewState = state;
      showPreview();
      previewLabel.innerHTML = label;
      
      switch (state) {
        case 'none':
          previewIcon.innerHTML = '';
          previewLabel.className = 'preview-label';
          break;
          
        case 'info':
          previewIcon.innerHTML = '';
          previewLabel.className = 'preview-label';
          break;
          
        case 'loading':
          previewIcon.innerHTML = '<div class="spinner"></div>';
          previewLabel.className = 'preview-label';
          break;
          
        case 'success':
          previewIcon.innerHTML = svgContent || '';
          previewLabel.className = 'preview-label';
          break;
          
        case 'error':
          previewIcon.innerHTML = '';
          previewLabel.className = 'preview-label error-text';
          break;
      }
    }


    // Utility functions
    function buildIconUrl(iconName, params) {
      const { style, weight, size, grade, fill } = params;
      
      // GitHub raw files URL pattern for Material Symbols
      const baseUrl = 'https://raw.githubusercontent.com/google/material-design-icons/master/symbols/web';
      
      // Build filename: iconName[_wght{weight}][_grad{grade}][fill1]_{size}px.svg
      // Note: weight 400 and grade 0 are omitted (defaults)
      let filename = iconName;
      if (weight !== 400) {
        filename += `_wght${weight}`;
      }
      if (grade !== 0) {
        // Handle negative grade values (N25 for -25)
        const gradeParam = grade < 0 ? `gradN${Math.abs(grade)}` : `grad${grade}`;
        filename += `_${gradeParam}`;
      }
      if (fill) {
        filename += 'fill1';
      }
      filename += `_${size}px.svg`;
      
      return `${baseUrl}/${iconName}/${style}/${filename}`;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
